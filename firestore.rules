rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }
    function emailLower() { return lower(request.auth.token.email); }
    function isHardAdmin() { return emailLower() == 'satny@gvid.cz'; }
    function allowDoc() { return get(/databases/$(database)/documents/allowlist/$(emailLower())); }
    function activeAllowlisted() { return signedIn() && (isHardAdmin() || (allowDoc().data.active == true)); }
    function role() { return isHardAdmin() ? 'admin' : allowDoc().data.role; }
    function canWrite() { return role() in ['requester', 'accountant', 'admin']; }
    function canManage() { return role() in ['accountant', 'admin']; }

    match /allowlist/{id} {
      allow read: if activeAllowlisted();
      allow write: if activeAllowlisted() && role() == 'admin';
    }
    match /users/{id} { allow read, write: if activeAllowlisted(); }
    match /months/{id} { allow read: if activeAllowlisted(); allow write: if canManage(); }
    match /queueRequests/{id} {
      allow read: if activeAllowlisted();
      allow create: if activeAllowlisted() && canWrite();
      allow update, delete: if activeAllowlisted() && canManage();
    }
    match /requests/{id} {
      allow read: if activeAllowlisted();
      allow write: if activeAllowlisted() && canManage();
    }
    match /events/{id} {
      allow read: if activeAllowlisted();
      allow write: if activeAllowlisted() && canManage();
    }
    match /audit/{id} {
      allow read: if activeAllowlisted() && canManage();
      allow create: if activeAllowlisted();
      allow update, delete: if false;
    }
    match /counters/{id} { allow read, write: if activeAllowlisted() && canManage(); }
  }
}

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }
    function emailLower() { return lower(request.auth.token.email); }
    function isSatny() { return emailLower() == 'satny@gvid.cz'; }
    function allowDoc() { return get(/databases/$(database)/documents/allowlist/$(emailLower())); }
    function isAllowlistedActive() { return isSatny() || (allowDoc().data.active == true); }
    function role() { return isSatny() ? 'admin' : allowDoc().data.role; }
    function canWrite() { return role() in ['accountant', 'admin']; }

    match /allowlist/{id} {
      allow read: if signedIn() && isAllowlistedActive();
      allow write: if signedIn() && role() == 'admin';
    }

    match /queueRequests/{id} {
      allow read: if signedIn() && isAllowlistedActive();
      allow create: if signedIn() && isAllowlistedActive() && role() in ['requester', 'accountant', 'admin'];
      allow update, delete: if signedIn() && canWrite();
    }

    match /requests/{id} {
      allow read: if signedIn() && isAllowlistedActive();
      allow write: if signedIn() && canWrite();
    }

    match /events/{id} {
      allow read: if signedIn() && isAllowlistedActive();
      allow write: if signedIn() && canWrite();
    }

    match /months/{id} {
      allow read: if signedIn() && isAllowlistedActive();
      allow write: if signedIn() && canWrite();
    }

    match /audit/{id} {
      allow read: if signedIn() && canWrite();
      allow create: if signedIn() && isAllowlistedActive();
      allow update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}

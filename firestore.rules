rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }
    function email() { return request.auth.token.email; }

    // satny@gvid.cz je vždy admin
    function isSatny() { return signedIn() && email() == 'satny@gvid.cz'; }

    // allowlist dokument je uložen pod ID = email
    function allowDoc() {
      return get(/databases/$(database)/documents/allowlist/$(email()));
    }

    function isAllowlistedActive() {
      return isSatny() || (signedIn() && allowDoc().data.active == true);
    }

    function role() {
      return isSatny() ? 'admin' : allowDoc().data.role;
    }

    function canWrite() { return role() in ['accountant', 'admin']; }

    match /allowlist/{id} {
      allow read: if signedIn() && isAllowlistedActive();
      allow write: if signedIn() && role() == 'admin';
    }

    match /queueRequests/{id} {
      allow read: if signedIn() && isAllowlistedActive();
      allow create: if signedIn() && isAllowlistedActive()
        && role() in ['requester', 'accountant', 'admin'];
      allow update, delete: if signedIn() && canWrite();
    }

    match /requests/{id} {
      allow read: if signedIn() && isAllowlistedActive();
      allow write: if signedIn() && canWrite();
    }

    match /events/{id} {
      allow read: if signedIn() && isAllowlistedActive();
      allow write: if signedIn() && canWrite();
    }

    match /months/{id} {
      allow read: if signedIn() && isAllowlistedActive();
      allow write: if signedIn() && canWrite();
    }

    match /audit/{id} {
      allow read: if signedIn() && canWrite();
      allow create: if signedIn() && isAllowlistedActive();
      allow update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
